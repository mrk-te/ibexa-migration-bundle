# test  creation / updating / deleting of content. We use a custom content type for that, not to rely on the standard ones...

-
    type: content_type
    mode: create
    content_type_group: 1
    identifier: kmb_test_004
    name: Kaliop Migration Bundle Test Class 2
    name_pattern: '<ibexa_string>'
    is_container: true
    always_available: true
    attributes:
        -
            type: ibexa_string
            name: ibexa_string
            identifier: ibexa_string
        -
            type: ibexa_author
            name: ibexa_author
            identifier: ibexa_author
        -
            type: ibexa_binaryfile
            name: ibexa_binaryfile
            identifier: ibexa_binaryfile
        -
            type: ibexa_boolean
            name: ibexa_boolean
            identifier: ibexa_boolean
        -
            type: ibexa_country
            name: ibexa_country
            identifier: ibexa_country
            field-settings:
                isMultiple: true
        -
            type: ibexa_datetime
            name: ibexa_datetime
            identifier: ibexa_datetime
        -
            type: ibexa_date
            name: ibexa_date
            identifier: ibexa_date
        -
            type: ibexa_email
            name: ibexa_email
            identifier: ibexa_email
        -
            type: ibexa_float
            name: ibexa_float
            identifier: ibexa_float
        # @todo ibexa_gmap_location fieldType seems to be enabled by default, but the db table might *not* be present...
        #-
        #    type: ibexa_gmap_location
        #    name: ibexa_gmap_location
        #    identifier: ibexa_gmap_location
        -
            type: ibexa_image
            name: ibexa_image
            identifier: ibexa_image
        -
            type: ibexa_integer
            name: ibexa_integer
            identifier: ibexa_integer
        -
            type: ibexa_isbn
            name: ibexa_isbn
            identifier: ibexa_isbn
        -
            type: ibexa_keyword
            name: ibexa_keyword
            identifier: ibexa_keyword
        -
            type: ibexa_media
            name: ibexa_media
            identifier: ibexa_media
        -
            type: ibexa_object_relation
            name: ibexa_object_relation
            identifier: ibexa_object_relation
        -
            type: ibexa_object_relation_list
            name: ibexa_object_relation_list
            identifier: ibexa_object_relation_list
        -
            type: ibexa_richtext
            name: ibexa_richtext
            identifier: ibexa_richtext
        # nb: ezsrrating fieldType seems to be enabled by default, but the db table might *not* be present...
        #-
        #    type: ezsrrating
        #    name: ezsrrating
        #    identifier: ezsrrating
        -
            type: ibexa_text
            name: ibexa_text
            identifier: ibexa_text
        -
            type: ibexa_time
            name: ibexa_time
            identifier: ibexa_time
        -
            type: ibexa_url
            name: ibexa_url
            identifier: ibexa_url
        # @todo an ibexa_user field can not be null on content creation (bad sql generated...), so we disable it here.
        #       Move to a separate test
        #-
        #    type: ibexa_user
        #    name: ibexa_user
        #    identifier: ibexa_user
    references:
        -
            identifier: kmb_test_004
            attribute: identifier
        -
            identifier: kmb_test_004_0
            attribute: id
-
    type: content
    mode: create
    content_type: reference:kmb_test_004
    parent_location: 2
    section: 3
    owner: admin
    attributes:
        - ibexa_string: hello world 1
    object_states:
        - locked
    references:
        -
            identifier: kmb_test_004_1
            attribute: object_id
        -
            identifier: kmb_test_004_1_loc
            attribute: location_id
        -
            identifier: kmb_test_004_1_path
            attribute: path
        -
            identifier: kmb_test_004_1_crid
            attribute: content_remote_id
        -
            identifier: kmb_test_004_1_rid
            attribute: remote_id
        -
            identifier: kmb_test_004_1_always_available
            attribute: always_available
        -
            identifier: kmb_test_004_1_content_id
            attribute: content_id
        -
            identifier: kmb_test_004_1_content_type_id
            attribute: content_type_id
        -
            identifier: kmb_test_004_1_content_type_identifier
            attribute: content_type_identifier
        -
            identifier: kmb_test_004_1_current_version
            attribute: current_version
        -
            identifier: kmb_test_004_1_current_version_no
            attribute: current_version_no
        -
            identifier: kmb_test_004_1_main_location_id
            attribute: main_location_id
        -
            identifier: kmb_test_004_1_main_language_code
            attribute: main_language_code
        -
            identifier: kmb_test_004_1_modification_date
            attribute: modification_date
        -
            identifier: kmb_test_004_1_name
            attribute: name
        -
            identifier: kmb_test_004_1_owner_id
            attribute: owner_id
        -
            identifier: kmb_test_004_1_publication_date
            attribute: publication_date
        -
            identifier: kmb_test_004_1_section_id
            attribute: section_id
        -
            identifier: kmb_test_004_1_section_identifier
            attribute: section_identifier

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1
    test:
        equals: reference:kmb_test_004_1_content_id

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1_crid
    test:
        equals: reference:kmb_test_004_1_rid

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1_content_type_identifier
    test:
        equals: kmb_test_004

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1_current_version
    test:
        equals: 1

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1_current_version_no
    test:
        equals: 1

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1_section_id
    test:
        equals: 3

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1_section_identifier
    test:
        equals: media

-
    type: content_type
    mode: update
    match:
        identifier: kmb_test_004
    attributes:
        -
            type: ibexa_object_relation_list
            name: ibexa_object_relation_list
            identifier: ibexa_object_relation_list
            field-settings:
                selectionDefaultLocation: reference:kmb_test_004_1_loc

-
    type: content
    mode: create
    content_type: reference:kmb_test_004
    parent_location: 2
    attributes:
        - ibexa_string: hello world 2
        - ibexa_object_relation: 'reference:kmb_test_004_1'
        - ibexa_object_relation_list: [ 'reference:kmb_test_004_1' ]
    references:
        -
            identifier: kmb_test_004_2
            attribute: object_id

-
    type: content
    mode: create
    content_type: reference:kmb_test_004
    parent_location: reference:kmb_test_004_1_loc
    location_remote_id: kmb_test_004_3_location_remote_id
    priority: 1999
    is_hidden: true
    sort_field: path
    sort_order: DESC
    modification_date: "2006:07:08 18:11:31"
    publication_date: "2005:08:09 18:11:31"
    version_creator: anonymous
    attributes:
        ibexa_string: hello world 3
        # Issue # 224
        ibexa_country: ALB
    references:
        -
            identifier: kmb_test_004_3
            attribute: object_id
        -
            identifier: kmb_test_004_3_ibexa_country
            attribute: 'attributes.ibexa_country[0]'
            overwrite: true

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_3_ibexa_country
    test:
        equals: AL

-
    type: reference
    mode: set
    identifier: kmb_test_004_3_ibexa_country_set
    value: [ AFG ]

-
    type: content
    mode: update
    match:
        location_remote_id: kmb_test_004_3_location_remote_id
    attributes:
        ibexa_country: reference:kmb_test_004_3_ibexa_country_set
    references:
        -
            identifier: kmb_test_004_3_ibexa_country
            attribute: 'attributes.ibexa_country[0]'
            overwrite: true

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_3_ibexa_country
    test:
        equals: AF

-
    type: reference
    mode: set
    identifier: kmb_test_004_3_ibexa_country_set
    overwrite: true
    value: Algeria

-
    type: content
    mode: update
    match:
        location_remote_id: kmb_test_004_3_location_remote_id
    attributes:
        ibexa_country: [ 'reference:kmb_test_004_3_ibexa_country_set' ]
    references:
        -
            identifier: kmb_test_004_3_ibexa_country
            attribute: 'attributes.ibexa_country[0]'
            overwrite: true

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_3_ibexa_country
    test:
        equals: DZ

-
    type: content_type
    mode: update
    match:
        identifier: kmb_test_004
    attributes:
        -
            type: ibexa_object_relation_list
            name: ibexa_object_relation_list
            identifier: ibexa_object_relation_list
            field-settings:
                selectionDefaultLocation: location:kmb_test_004_3_location_remote_id

-
    type: content
    mode: create
    content_type: reference:kmb_test_004
    parent_location: 2
    priority: 1999
    remote_id: this_is_a_test_remoteid
    attributes:
        - ibexa_string: hello world 4
        - ibexa_image:
            path: blank.jpg
            alt_text: a blank 1x1 px image
            filename: lol1.jpg
        - ibexa_binaryfile:
            path: emptyfile.txt
            filename: lol2.txt
        - ibexa_media:
            path: small.flv
            filename: lol3.flv
        - ibexa_richtext:
            content: '<?xml version="1.0" encoding="UTF-8"?><section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ezxhtml="http://ez.no/xmlns/ezpublish/docbook/xhtml" xmlns:ezcustom="http://ez.no/xmlns/ezpublish/docbook/custom" version="5.0-variant ezpublish-1.0"><para><link xlink:href="ezcontent://[reference:kmb_test_004_1]">Content link</link></para></section>'
        - ibexa_author:
            -
                name: Author 1
                email: test1@example.com
            -
                name: Author 2
                email: test2@example.com
        - ibexa_country:
            - Afghanistan
            - AX
            - ALB
        - ibexa_object_relation:
            destinationContentId: 'reference:kmb_test_004_1'
        - ibexa_object_relation_list:
            destinationContentIds: [ 'reference:kmb_test_004_1', 'reference:kmb_test_004_2' ]
# Currently fails... :-(
# Error message: Argument 'BinaryFile::id' is invalid: '/content/download/55/249' is wrong value, it does not contain prefix '/var/behat_site/storage/'. Is 'var_dir' config correct?
#    references:
#        -
#            identifier: kmb_test_004_10_mimetype
#            attribute: attributes.ibexa_binaryfile.mimeType

# Currently fails... See: https://github.com/kaliop-uk/ezmigrationbundle/issues/147
#-
#    type: assert
#    target: reference
#    identifier: reference:kmb_test_004_10_mimetype
#    test:
#        equals: something/else

-
    type: content
    mode: create
    content_type: kmb_test_004
    parent_location: 2
    attributes:
        ibexa_string: null
        ibexa_author: null
        ibexa_binaryfile: null
        ibexa_boolean: null
        ibexa_country: null
        ibexa_datetime: null
        ibexa_date: null
        ibexa_email: null
        ibexa_float: null
        ibexa_image: null
        ibexa_integer: null
        ibexa_isbn: null
        ibexa_keyword: null
        ibexa_media: null
        ibexa_object_relation: null
        ibexa_object_relation_list: null
        ibexa_richtext: null
        ibexa_text: null
        ibexa_time: null
        ibexa_url: null
        #ibexa_user: null

-
    type: content
    mode: update
    match:
        content_id: reference:kmb_test_004_1
    attributes:
        - ibexa_image: blank.jpg
        - ibexa_binaryfile: emptyfile.txt
    section: users
    version_creator: 14
    owner: 10
    new_remote_id: is_this_a_very_unlikely_remoteid
    modification_date: "2008:07:06 18:11:31"
    publication_date: "2007:08:09 18:11:31"
    references:
        -
            identifier: kmb_test_004_8_current_version
            attribute: current_version
        -
            identifier: kmb_test_004_8_count
            attribute: count

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_8_count
    test:
        equals: 1

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_8_current_version
    test:
        equals: 2

-
    type: content
    mode: update
    match:
        content_id: reference:kmb_test_004_1
    new_remote_id: this_is_a_very_unlikely_remoteid
    references:
        -
            identifier: kmb_test_004_9_current_version
            attribute: current_version
        -
            identifier: kmb_test_004_9_count
            attribute: count

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_9_count
    test:
        equals: 1

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_9_current_version
    test:
        equals: 2

# @todo test as many conditions as possible
-
    type: content
    mode: load
    match:
        and:
            - attribute:
                ibexa_string:
                    eq: 'hello world 1'
            - content_id: reference:kmb_test_004_1
            - content_remote_id: this_is_a_very_unlikely_remoteid
            - content_type_id: reference:kmb_test_004_0
            - content_type_identifier: reference:kmb_test_004
            - creation_date:
                gt: 1234567
            #- group:
            - lang: reference:kmb_test_004_1_main_language_code
            - location_id: reference:kmb_test_004_1_loc
            #- object_state:
            - owner: anonymous
            - section: 2
            - not:
                visibility: false
    references:
        -
            identifier: kmb_test_004_4
            attribute: object_id

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_1
    test:
        equals: reference:kmb_test_004_4

-
    type: content
    mode: delete
    object_id: [ 'reference:kmb_test_004_2', 'reference:kmb_test_004_3' ]
    references:
        -
            identifier: kmb_test_004_5
            attribute: count

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_5
    test:
        equals: 2

-
    type: content
    mode: delete
    match:
        content_type: reference:kmb_test_004
    references:
        -
            identifier: kmb_test_004_6_count
            attribute: count

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_6_count
    test:
        equals: 3

-
    type: content_type
    mode: delete
    identifier: 'reference:kmb_test_004'
    references:
        -
            identifier: kmb_test_004_7_count
            attribute: count

-
    type: assert
    target: reference
    identifier: reference:kmb_test_004_7_count
    test:
        equals: 1
